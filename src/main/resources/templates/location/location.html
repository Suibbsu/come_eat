<!DOCTYPE html>
<html　xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지역별 맛집</title>
    <link rel="stylesheet" href="/css/location.css">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e951a9675edffd5bbc4faec7164c3441&libraries=services&libraries=clusterer"></script>
</head>
<body>
	<th:block th:include="common/header"></th:block>
    <div class="content-wrap">
        <div class="content-title">지역별 맛집</div>
        <div class="location-btn">
            <div>
                <a href="/location/foodList?pageNo=1&lo=su" class="btn lo-btn" title="서울맛집">서울</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=kkd" class="btn lo-btn" title="경기도맛집">경기도</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=ic" class="btn lo-btn" title="인천맛집">인천</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=bs" class="btn lo-btn" title="부산맛집">부산</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=dg" class="btn lo-btn" title="대구맛집">대구</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=kh" class="btn lo-btn" title="김해맛집">김해</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=jj" class="btn lo-btn" title="전주맛집">전주</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=jn" class="btn lo-btn" title="전남맛집">전남</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=cb" class="btn lo-btn" title="충북맛집">충북</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=ph" class="btn lo-btn" title="포항맛집">포항</a>
            </div>
            <div>
                <a href="/location/foodList?pageNo=1&lo=yj" class="btn lo-btn" title="영주맛집">영주</a>
            </div>
        </div>
        <div th:if="${list != null}">        
	        <div class="sub-title clear" th:text="${title}"></div>
	        <div class="location-map">
	            	<div id="map" style="width:100%;height:100%;"></div>
	        </div>
	        <div class="location-content-wrap"> 
	            <div class="location-content" th:each="location : ${list}">
	                <a th:href="@{/review/detailRestaurant(loNo=${location.loNo})}">
	                    <div class="location-img-box" th:style="'background-image:url(' + ${location.loThumb} + ');'">
	                    </div>
	                    <div class="location-content-info">
	                        <p th:text="${location.loTitle}"></p>
	                        <p th:text="${location.loInfo}"></p>
	                        <div class="star">
	                            <span class="material-icons-round">grade</span>
	                            <span>4.5</span>
	                        </div>
	                    </div>
	                </a>
	            </div>
	        </div>
	        <div class="board-navi" th:utext="${navi}"></div>
	        
	        
	        
        </div>
    </div>
    <th:block th:include="common/footer"></th:block>
    
    <script th:inline="javascript">

		//지도
		window.onload = function(){
			const list = [[${list}]];
			const loCode = list[0].loCode;
			const title = [[${title}]];
			
			if(list.length != 0){
				
				//클릭한 버튼만 색상 변경
				$(".lo-btn").each(function(index, item){
					if($(item).attr("title") == title){
						$(item).addClass("active-btn");
					}
				})
				
				//지도에는 전체위치 출력하기 위해 비동기 요청
				$.ajax({
					url : "/location/map",
					type : "get",
					data : {loCode:loCode},
					success : function(data){
						//카카오 지도 API
						const container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
						const options = { //지도를 생성할 때 필요한 기본 옵션
							center: new kakao.maps.LatLng(data[0].loLat, data[0].loLng), //지도의 중심좌표.
							level: 10 //지도의 레벨(확대, 축소 정도)
						};
						const map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
						
						//오버레이 div 배열
						const contents = [];
						
						// 마커 클러스터러를 생성합니다 
					    var clusterer = new kakao.maps.MarkerClusterer({
					        map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체 
					        averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정 
					        minLevel: 8 // 클러스터 할 최소 지도 레벨 
					    });

						//마커
						for(let i=0; i<data.length;i++){
							// 데이터를 가져오기 위해 jQuery를 사용합니다
						    // 데이터를 가져와 마커를 생성하고 클러스터러 객체에 넘겨줍니다

						    //마커가 표시될 위치
							const markerPosition  = new kakao.maps.LatLng(data[i].loLat, data[i].loLng);
							//마커 생성
							const marker = new kakao.maps.Marker({
								position: markerPosition,
								clickable: true // 마커를 클릭했을 때 지도의 클릭 이벤트가 발생하지 않도록 설정합니다
							});
							// 마커를 지도에 표시합니다.
							
							marker.setMap(map);
						    // 클러스터러에 마커들을 추가합니다
						    clusterer.addMarkers(marker);
						    
						    
						    //마커 클릭이벤트
							kakao.maps.event.addListener(marker, 'click', function(){
								//지도 중심 위치 이동
								const moveLatLon = new kakao.maps.LatLng(data[i].loLat, data[i].loLng);
								map.panTo(moveLatLon);
								
								//오버레이 dom생성
								const markerDiv = $("<div>").addClass("marker").css("cursor", "pointer");
								
								const markerBox = $("<div>").addClass("marker-box");
								const markerL = $("<div>").addClass("marker-l").css("background-image","url("+data[i].loThumb+")");
								const markerR = $("<div>").addClass("marker-r");
								const markerR1 = $("<div>").text(data[i].loTitle);
								const markerR2 = $("<div>").text(data[i].loAddr);
								markerR.append(markerR1).append(markerR2);
								markerBox.append(markerL).append(markerR);
								
								const markerLastBox = $("<div>").addClass("marker-last-box");
								
								const close = $("<div>").addClass("close");
								const span = $("<span>close</span>").addClass("material-icons");
								close.append(span);
								
								const content = markerDiv.append(markerBox).append(markerLastBox).append(close);
								
								// 마커 위에 커스텀오버레이를 표시합니다
								const overlay = new kakao.maps.CustomOverlay({
									content: content[0],
									position: marker.getPosition()
								});
								
								//마커 클릭했을 때 오버레이 표시
								overlay.setMap(map);
								
								//오버레이 클로즈버튼 구현
								close.on("click",function(){
									overlay.setMap(null);
									window.event.stopPropagation();//이벤트버블링제거
								});
								//상세페이지로 이동
								markerDiv.on("click",function(){
									location.href="/review/detailRestaurant?loNo="+data[i].loNo;
								});
							});
 						    
						}						
					}
				});
			}
		};
		
    </script>
</body>
</html>